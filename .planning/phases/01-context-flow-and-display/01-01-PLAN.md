---
phase: 01-context-flow-and-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/macuser/.claude/commands/gsd/plan-phase.md
autonomous: true

must_haves:
  truths:
    - "CONTEXT.md is loaded in Step 4 before any agent spawns"
    - "Researcher receives CONTEXT.md with structured guidance (locked/discretion/deferred)"
    - "Planner receives CONTEXT.md with structured guidance (locked/discretion/deferred)"
    - "Checker receives CONTEXT.md with structured guidance for compliance validation"
    - "Revision loop receives CONTEXT.md to preserve user decisions during revisions"
    - "Both CONTEXT.md and {phase}-CONTEXT.md patterns are detected via glob"
  artifacts:
    - path: "/Users/macuser/.claude/commands/gsd/plan-phase.md"
      provides: "CONTEXT.md loading in Step 4 + structured context guidance in all 4 agent prompts"
      contains: "CONTEXT_CONTENT=$(cat"
  key_links:
    - from: "Step 4 CONTEXT_CONTENT variable"
      to: "Research prompt phase_context section"
      via: "Variable substitution in prompt template"
      pattern: "context_content"
    - from: "Step 4 CONTEXT_CONTENT variable"
      to: "Checker prompt verification_context section"
      via: "Variable substitution in prompt template"
      pattern: "context_content"
    - from: "Step 4 CONTEXT_CONTENT variable"
      to: "Revision prompt revision_context section"
      via: "Variable substitution in prompt template"
      pattern: "context_content"
---

<objective>
Port CONTEXT.md flow additions to plan-phase.md orchestrator

Purpose: Ensure user decisions from /gsd:discuss-phase propagate to ALL downstream agents (researcher, planner, checker, revision loop) with structured guidance on how to use them.

Output: Updated plan-phase.md with early CONTEXT.md loading (Step 4) and enhanced context guidance in all 4 agent prompt templates.
</objective>

<execution_context>
@/Users/macuser/.claude/get-shit-done/workflows/execute-plan.md
@/Users/macuser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-context-flow-and-display/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CONTEXT.md early loading in Step 4</name>
  <files>/Users/macuser/.claude/commands/gsd/plan-phase.md</files>
  <action>
In plan-phase.md, after the Step 4 bash block (after line 120, the closing triple-backtick of the mkdir block), and BEFORE "## 5. Handle Research", insert the following new section:

```markdown
Load CONTEXT.md now — before any agents spawn:

```bash
# Load CONTEXT.md immediately - this informs ALL downstream agents
CONTEXT_CONTENT=$(cat "${PHASE_DIR}"/*-CONTEXT.md 2>/dev/null)
```

**CRITICAL:** Store `CONTEXT_CONTENT` now. It must be passed to:
- **Researcher** — constrains what to research (locked decisions vs Claude's discretion)
- **Planner** — locked decisions must be honored, not revisited
- **Checker** — verifies plans respect user's stated vision
- **Revision** — context for targeted fixes

If CONTEXT.md exists, display: `Using phase context from: ${PHASE_DIR}/*-CONTEXT.md`
```

This adds ~15 lines between Step 4 and Step 5. The glob pattern `*-CONTEXT.md` handles both `CONTEXT.md` and `{phase}-CONTEXT.md` naming conventions (CTXF-07).
  </action>
  <verify>
Read the file and confirm:
1. The new CONTEXT.md loading section appears AFTER the Step 4 mkdir bash block
2. The new section appears BEFORE "## 5. Handle Research"
3. The glob pattern `*-CONTEXT.md` is used (not a hardcoded filename)
4. The variable name is `CONTEXT_CONTENT` (matching the existing usage at line 246)
  </verify>
  <done>Step 4 loads CONTEXT.md into CONTEXT_CONTENT before any agent spawns. Both CONTEXT.md and {phase}-CONTEXT.md patterns are detected.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance all 4 agent prompt templates with structured context guidance</name>
  <files>/Users/macuser/.claude/commands/gsd/plan-phase.md</files>
  <action>
Make 4 edits to plan-phase.md to add structured CONTEXT.md guidance to each agent prompt:

**Edit 1 - Research prompt (around line 198-199):**
Replace the existing simple phase_context section:
```markdown
**Phase context (if any):**
{phase_context}
```

With structured guidance:
```markdown
<phase_context>
**IMPORTANT:** If CONTEXT.md exists below, it contains user decisions from /gsd:discuss-phase.

- **Decisions section** = Locked choices — research THESE deeply, don't explore alternatives
- **Claude's Discretion section** = Your freedom areas — research options, make recommendations
- **Deferred Ideas section** = Out of scope — ignore completely

{context_content}
</phase_context>
```

**Edit 2 - Planner prompt (around line 282-283):**
Replace the existing generic context line:
```markdown
**Phase Context (if exists):**
{context_content}
```

With structured guidance:
```markdown
**Phase Context (if exists):**

IMPORTANT: If phase context exists below, it contains USER DECISIONS from /gsd:discuss-phase.
- **Decisions** = LOCKED — honor these exactly, do not revisit or suggest alternatives
- **Claude's Discretion** = Your freedom — make implementation choices here
- **Deferred Ideas** = Out of scope — do NOT include in this phase

{context_content}
```

**Edit 3 - Checker prompt (around line 377, after `{requirements_content}`):**
Add a NEW section inside the `<verification_context>` block, before the closing `</verification_context>`:
```markdown
**Phase Context (if exists):**

IMPORTANT: If phase context exists below, it contains USER DECISIONS from /gsd:discuss-phase.
Plans MUST honor these decisions. Flag as issue if plans contradict user's stated vision.

- **Decisions** = LOCKED — plans must implement these exactly
- **Claude's Discretion** = Freedom areas — plans can choose approach
- **Deferred Ideas** = Out of scope — plans must NOT include these

{context_content}
```

**Edit 4 - Revision prompt (around line 436, inside `<revision_context>`):**
After `{structured_issues_from_checker}` and before `</revision_context>`, add:
```markdown
**Phase Context (if exists):**

IMPORTANT: If phase context exists below, it contains USER DECISIONS from /gsd:discuss-phase.
Preserve these decisions during revision — do NOT lose or contradict them.

- **Decisions** = LOCKED — must remain honored after revision
- **Claude's Discretion** = Freedom areas — can adjust approach
- **Deferred Ideas** = Out of scope — must remain excluded

{context_content}
```

IMPORTANT: Use the Read tool to find exact current text before each edit. The line numbers are approximate — match on the actual text content, not line numbers.
  </action>
  <verify>
Read the full file and confirm:
1. Research prompt has `<phase_context>` section with "Decisions section = Locked choices" guidance
2. Planner prompt has "LOCKED — honor these exactly" guidance before `{context_content}`
3. Checker prompt has "Plans MUST honor these decisions" guidance with `{context_content}`
4. Revision prompt has "Preserve these decisions during revision" guidance with `{context_content}`
5. All 4 prompts use `{context_content}` placeholder (lowercase, for template substitution)
  </verify>
  <done>All 4 agent prompts (researcher, planner, checker, revision) include structured CONTEXT.md guidance with locked/discretion/deferred classification.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Read the full plan-phase.md file
2. Search for "CONTEXT_CONTENT" — should appear in Step 4 (new), Step 7 (existing line 246), and conceptually referenced in all agent prompts via `{context_content}`
3. Search for "Locked" or "LOCKED" — should appear in 4 places (one per agent prompt)
4. Confirm the file structure is valid markdown (no broken code blocks)
5. Count total lines added — should be approximately 100 lines
</verification>

<success_criteria>
- CONTEXT.md loaded in Step 4 before any agent spawning (CTXF-01)
- Researcher prompt has structured context guidance (CTXF-02)
- Planner prompt has structured context guidance (CTXF-03)
- Checker prompt receives CONTEXT.md for compliance validation (CTXF-04)
- Revision prompt preserves CONTEXT.md during revisions (CTXF-05)
- Both CONTEXT.md and {phase}-CONTEXT.md detected via glob (CTXF-07)
</success_criteria>

<output>
After completion, create `.planning/phases/01-context-flow-and-display/01-01-SUMMARY.md`
</output>
