---
phase: 01-context-flow-and-display
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/macuser/.claude/agents/gsd-plan-checker.md
  - /Users/macuser/.claude/hooks/gsd-statusline.js
autonomous: true

must_haves:
  truths:
    - "Plan checker validates plans against user decisions from CONTEXT.md (Dimension 7)"
    - "Plan checker understands CONTEXT.md structure via upstream_input section"
    - "Context bar shows 100% when Claude Code hits its 80% limit"
    - "Color thresholds are adjusted for scaled display (green < 63%, yellow < 81%, orange < 95%, red >= 95%)"
  artifacts:
    - path: "/Users/macuser/.claude/agents/gsd-plan-checker.md"
      provides: "Dimension 7: Context Compliance verification + upstream_input section"
      contains: "Dimension 7: Context Compliance"
    - path: "/Users/macuser/.claude/hooks/gsd-statusline.js"
      provides: "Scaled context bar display (80% real = 100% shown)"
      contains: "rawUsed / 80"
  key_links:
    - from: "plan-phase.md checker prompt {context_content}"
      to: "gsd-plan-checker.md Dimension 7"
      via: "CONTEXT.md content passed in verification_context, checker knows to check Dimension 7"
      pattern: "context_compliance"
    - from: "remaining_percentage input"
      to: "scaled used percentage output"
      via: "Formula: Math.min(100, Math.round((rawUsed / 80) * 100))"
      pattern: "rawUsed.*80.*100"
---

<objective>
Port context compliance verification to plan checker and scale context bar display

Purpose: (1) Enable the plan checker to validate plans against user decisions from CONTEXT.md, catching violations before execution. (2) Fix context bar to show 100% at Claude Code's 80% enforcement limit for intuitive UX.

Output: Updated gsd-plan-checker.md with Dimension 7 and upstream_input section. Updated gsd-statusline.js with scaled percentage and adjusted color thresholds.
</objective>

<execution_context>
@/Users/macuser/.claude/get-shit-done/workflows/execute-plan.md
@/Users/macuser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-context-flow-and-display/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add upstream_input section and Dimension 7 to plan checker</name>
  <files>/Users/macuser/.claude/agents/gsd-plan-checker.md</files>
  <action>
Make 4 edits to gsd-plan-checker.md:

**Edit 1 - Add upstream_input section (after `</role>` tag, before `<core_principle>`):**

Insert this new section immediately after the closing `</role>` tag (line 26):

```markdown
<upstream_input>
**CONTEXT.md** (if exists) — User decisions from `/gsd:discuss-phase`

| Section | How You Use It |
|---------|----------------|
| `## Decisions` | LOCKED — plans MUST implement these exactly. Flag if contradicted. |
| `## Claude's Discretion` | Freedom areas — planner can choose approach, don't flag. |
| `## Deferred Ideas` | Out of scope — plans must NOT include these. Flag if present. |

If CONTEXT.md exists, add a verification dimension: **Context Compliance**
- Do plans honor locked decisions?
- Are deferred ideas excluded?
- Are discretion areas handled appropriately?
</upstream_input>
```

**Edit 2 - Add Dimension 7 (after Dimension 6, before `</verification_dimensions>`):**

After the closing triple-backtick of the Dimension 6 example issue (around line 236), add:

```markdown
## Dimension 7: Context Compliance (if CONTEXT.md exists)

**Question:** Do plans honor user decisions from /gsd:discuss-phase?

**Only check this dimension if CONTEXT.md was provided in the verification context.**

**Process:**
1. Parse CONTEXT.md sections: Decisions, Claude's Discretion, Deferred Ideas
2. For each locked Decision, find task(s) that implement it
3. Verify no tasks implement Deferred Ideas (scope creep)
4. Verify Discretion areas are handled (planner's choice is valid)

**Red flags:**
- Locked decision has no implementing task
- Task contradicts a locked decision (e.g., user said "cards layout", plan says "table layout")
- Task implements something from Deferred Ideas
- Plan ignores user's stated preference

**Example issue:**
```yaml
issue:
  dimension: context_compliance
  severity: blocker
  description: "User locked decision: 'use existing API library', but Task 03 creates custom API client"
  plan: "08-02"
  fix_hint: "Update task to use existing library per user decision"
```
```

**Edit 3 - Update BRIEF.md reference to CONTEXT.md (line 264):**

Find the line that references `BRIEF.md`:
```
- Phase context (from BRIEF.md if exists)
```

Replace with:
```
- Phase context (from CONTEXT.md if exists)
```

**Edit 4 - Add context compliance to success criteria (inside `<success_criteria>`):**

After the line `- [ ] must_haves derivation verified (user-observable truths)`, add:
```
- [ ] Context compliance checked (if CONTEXT.md provided: locked decisions honored, deferred ideas excluded)
```

IMPORTANT: Use the Read tool to find exact current text before each edit. Line numbers are approximate.
  </action>
  <verify>
Read the full file and confirm:
1. `<upstream_input>` section exists between `</role>` and `<core_principle>`
2. Dimension 7: Context Compliance section exists after Dimension 6
3. The word "BRIEF.md" no longer appears (replaced with "CONTEXT.md")
4. Success criteria includes context compliance checklist item
5. File structure is valid (all XML tags properly opened and closed)
  </verify>
  <done>Plan checker has Dimension 7: Context Compliance that validates plans against user decisions. Upstream_input section explains CONTEXT.md structure. BRIEF.md reference updated. Success criteria includes context compliance.</done>
</task>

<task type="auto">
  <name>Task 2: Scale context bar display and adjust color thresholds</name>
  <files>/Users/macuser/.claude/hooks/gsd-statusline.js</files>
  <action>
Make 2 edits to gsd-statusline.js:

**Edit 1 - Scale the percentage calculation (lines 21-25):**

Replace:
```javascript
    // Context window display (shows USED percentage)
    let ctx = '';
    if (remaining != null) {
      const rem = Math.round(remaining);
      const used = Math.max(0, Math.min(100, 100 - rem));
```

With:
```javascript
    // Context window display (shows USED percentage scaled to 80% limit)
    // Claude Code enforces an 80% context limit, so we scale to show 100% at that point
    let ctx = '';
    if (remaining != null) {
      const rem = Math.round(remaining);
      const rawUsed = Math.max(0, Math.min(100, 100 - rem));
      // Scale: 80% real usage = 100% displayed
      const used = Math.min(100, Math.round((rawUsed / 80) * 100));
```

Key changes:
- Variable renamed from `used` to `rawUsed` for the raw calculation
- New `used` variable applies scaling formula: `(rawUsed / 80) * 100`
- `Math.min(100, ...)` caps at 100% to prevent overflow
- Comments explain the scaling rationale

**Edit 2 - Adjust color thresholds (lines 31-37):**

Replace:
```javascript
      // Color based on usage
      if (used < 50) {
        ctx = ` \x1b[32m${bar} ${used}%\x1b[0m`;
      } else if (used < 65) {
        ctx = ` \x1b[33m${bar} ${used}%\x1b[0m`;
      } else if (used < 80) {
        ctx = ` \x1b[38;5;208m${bar} ${used}%\x1b[0m`;
```

With:
```javascript
      // Color based on scaled usage (thresholds adjusted for new scale)
      if (used < 63) {        // ~50% real
        ctx = ` \x1b[32m${bar} ${used}%\x1b[0m`;
      } else if (used < 81) { // ~65% real
        ctx = ` \x1b[33m${bar} ${used}%\x1b[0m`;
      } else if (used < 95) { // ~76% real
        ctx = ` \x1b[38;5;208m${bar} ${used}%\x1b[0m`;
```

Threshold mapping (old real% -> new scaled%):
- Green: was <50% real, now <63% scaled (~50% real)
- Yellow: was <65% real, now <81% scaled (~65% real)
- Orange: was <80% real, now <95% scaled (~76% real)
- Red: was >=80% real, now >=95% scaled (near 100%)
  </action>
  <verify>
Read the full file and confirm:
1. `rawUsed` variable exists with the raw percentage calculation
2. `used` variable applies scaling formula `(rawUsed / 80) * 100`
3. `Math.min(100, ...)` caps the result
4. Color thresholds are 63, 81, 95 (not 50, 65, 80)
5. Comments reference "~50% real", "~65% real", "~76% real"
6. Run: `echo '{"context_window":{"remaining_percentage":20}}' | node /Users/macuser/.claude/hooks/gsd-statusline.js` — should show 100% (80% used = 100% scaled)
  </verify>
  <done>Context bar shows 100% at Claude Code's 80% limit. Color thresholds adjusted for scaled display: green < 63%, yellow < 81%, orange < 95%, red >= 95%.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Read gsd-plan-checker.md — search for "Dimension 7" and "upstream_input"
2. Read gsd-statusline.js — search for "rawUsed" and thresholds "63", "81", "95"
3. Test statusline with sample inputs:
   - `echo '{"context_window":{"remaining_percentage":80}}' | node /Users/macuser/.claude/hooks/gsd-statusline.js` — expect 25% (green)
   - `echo '{"context_window":{"remaining_percentage":20}}' | node /Users/macuser/.claude/hooks/gsd-statusline.js` — expect 100% (red)
   - `echo '{"context_window":{"remaining_percentage":50}}' | node /Users/macuser/.claude/hooks/gsd-statusline.js` — expect 63% (yellow boundary)
</verification>

<success_criteria>
- Plan checker validates plans against user decisions via Dimension 7 (CTXF-06)
- Plan checker understands CONTEXT.md via upstream_input section
- Context bar shows 100% at 80% real usage (CTXD-01)
- Color thresholds at 63/81/95 for scaled display (CTXD-02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-context-flow-and-display/01-02-SUMMARY.md`
</output>
