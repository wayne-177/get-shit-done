---
phase: 03-git-branching
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - /Users/macuser/.claude/commands/gsd/execute-phase.md
  - /Users/macuser/.claude/commands/gsd/new-milestone.md
  - /Users/macuser/.claude/commands/gsd/complete-milestone.md
autonomous: true

must_haves:
  truths:
    - "Executing a phase with branching_strategy=phase creates a gsd/phase-{N}-{slug} branch before any plans run"
    - "Executing a phase with branching_strategy=milestone warns if not on a gsd/ branch"
    - "Executing a phase with branching_strategy=none stays on current branch (existing behavior)"
    - "Resuming a phase with branching_strategy=phase switches to existing branch instead of failing"
    - "Starting a new milestone with branching_strategy=milestone creates a gsd/{version}-{slug} branch"
    - "Completing a milestone with branching_strategy=milestone or phase shows merge guidance"
    - "Squash merge is documented as not-yet-implemented with manual workaround"
  artifacts:
    - path: "/Users/macuser/.claude/commands/gsd/execute-phase.md"
      provides: "Branch creation logic before wave execution"
      contains: "branching_strategy"
    - path: "/Users/macuser/.claude/commands/gsd/new-milestone.md"
      provides: "Milestone branch creation at milestone start"
      contains: "branching_strategy"
    - path: "/Users/macuser/.claude/commands/gsd/complete-milestone.md"
      provides: "Branch merge guidance at milestone completion"
      contains: "branching_strategy"
  key_links:
    - from: "/Users/macuser/.claude/commands/gsd/execute-phase.md"
      to: ".planning/config.json"
      via: "grep branching_strategy from config"
      pattern: "branching_strategy"
    - from: "/Users/macuser/.claude/commands/gsd/execute-phase.md"
      to: "git switch"
      via: "Branch creation/switch before wave execution"
      pattern: "git switch.*gsd/phase"
    - from: "/Users/macuser/.claude/commands/gsd/new-milestone.md"
      to: "git switch"
      via: "Milestone branch creation after PROJECT.md update"
      pattern: "git switch.*gsd/"
---

<objective>
Add branch creation logic to execute-phase, new-milestone, and complete-milestone commands.

Purpose: This plan implements the actual git branching behavior that the config (from Plan 01) controls. Phase branches are created at execute-phase start. Milestone branches are created at new-milestone time. Complete-milestone provides merge guidance. Squash merge is documented as not-yet-implemented.

Output: Three command files updated with branching logic. Users who set branching_strategy via /gsd:settings will get automatic branch management.
</objective>

<execution_context>
@/Users/macuser/.claude/get-shit-done/workflows/execute-plan.md
@/Users/macuser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-git-branching/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add branch creation logic to execute-phase</name>
  <files>
    /Users/macuser/.claude/commands/gsd/execute-phase.md
  </files>
  <action>
    Add a new step **1.5** (between step 1 "Validate phase exists" and step 2 "Discover plans") in the `<process>` section of execute-phase.md. This step handles branch creation/switching based on the branching strategy config.

    Insert this step:

    ```markdown
    1.5. **Handle branching strategy**

       Read branching strategy from config:
       ```bash
       BRANCHING_STRATEGY=$(cat .planning/config.json 2>/dev/null | grep -o '"branching_strategy"[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"' || echo "none")
       ```

       **If `BRANCHING_STRATEGY` = `"phase"`:**

       Extract phase name from ROADMAP.md and create/switch to branch:
       ```bash
       # Extract phase title (e.g., "Git Branching" from "### Phase 3: Git Branching")
       PHASE_TITLE=$(grep "^### Phase ${PHASE}:" .planning/ROADMAP.md | sed 's/.*Phase [0-9]*: //' | head -1)

       # Generate slug from title
       if [ -n "$PHASE_TITLE" ]; then
         PHASE_SLUG=$(echo "$PHASE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//' | cut -c1-50)
       else
         PHASE_SLUG="phase-${PHASE}"
       fi

       BRANCH_NAME="gsd/phase-${PHASE}-${PHASE_SLUG}"

       # Idempotent: check if branch exists before creating
       if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
         echo "Switching to existing branch: $BRANCH_NAME"
         git switch "$BRANCH_NAME" 2>/dev/null || git checkout "$BRANCH_NAME"
       else
         echo "Creating phase branch: $BRANCH_NAME"
         git switch -c "$BRANCH_NAME" 2>/dev/null || git checkout -b "$BRANCH_NAME"
       fi
       ```

       **If `BRANCHING_STRATEGY` = `"milestone"`:**

       Verify we're on a gsd/ branch (milestone branch should already exist from /gsd:new-milestone):
       ```bash
       CURRENT_BRANCH=$(git branch --show-current)
       if [[ ! "$CURRENT_BRANCH" =~ ^gsd/ ]]; then
         echo "Warning: Branching strategy is 'milestone' but not on a gsd/ branch."
         echo "Current branch: $CURRENT_BRANCH"
         echo "Create milestone branch with /gsd:new-milestone or change strategy with /gsd:settings"
         echo ""
         echo "Continuing on current branch..."
       fi
       ```

       **If `BRANCHING_STRATEGY` = `"none"` (default):**

       No action needed. Continue on current branch.
    ```

    Important: Do NOT renumber existing steps. Insert as step 1.5 to minimize diff and make the insertion point clear. The step numbering already has gaps in style (0, 1, 2...) so 1.5 fits naturally.
  </action>
  <verify>
    1. Read execute-phase.md — verify step 1.5 exists between step 1 and step 2
    2. Verify BRANCHING_STRATEGY is read from config.json with "none" default
    3. Verify phase branch creation uses idempotent pattern (check before create)
    4. Verify milestone strategy checks for gsd/ branch prefix and warns (doesn't block)
    5. Verify slug generation uses tr/sed pattern from add-phase.md
    6. Verify branch name format is gsd/phase-{N}-{slug}
    7. Verify git switch with checkout fallback pattern used
  </verify>
  <done>
    execute-phase.md creates gsd/phase-{N}-{slug} branch when strategy is "phase", warns when strategy is "milestone" but not on gsd/ branch, and does nothing when strategy is "none". Branch creation is idempotent (supports resume).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add milestone branch creation to new-milestone and merge guidance to complete-milestone</name>
  <files>
    /Users/macuser/.claude/commands/gsd/new-milestone.md
    /Users/macuser/.claude/commands/gsd/complete-milestone.md
  </files>
  <action>
    **new-milestone.md:**

    Add a new step **Phase 6.7** (after Phase 6.5 "Resolve Model Profile" and before Phase 7 "Research Decision") that creates a milestone branch when the branching strategy is set to "milestone":

    ```markdown
    ## Phase 6.7: Handle Branching Strategy

    Read branching strategy from config:
    ```bash
    BRANCHING_STRATEGY=$(cat .planning/config.json 2>/dev/null | grep -o '"branching_strategy"[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"' || echo "none")
    ```

    **If `BRANCHING_STRATEGY` = `"milestone"`:**

    Create milestone branch after PROJECT.md is committed:
    ```bash
    # Extract milestone version (e.g., "v1.1" from "## Current Milestone: v1.1 Upstream Port")
    MILESTONE_VERSION=$(grep "^## Current Milestone:" .planning/PROJECT.md | sed 's/.*: //' | awk '{print $1}')

    # Extract milestone name/goal for slug
    MILESTONE_NAME=$(grep "^## Current Milestone:" .planning/PROJECT.md | sed 's/.*: v[0-9.]* //' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//' | cut -c1-40)

    BRANCH_NAME="gsd/${MILESTONE_VERSION}-${MILESTONE_NAME}"

    # Idempotent: check if branch exists
    if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
      echo "Switching to existing milestone branch: $BRANCH_NAME"
      git switch "$BRANCH_NAME" 2>/dev/null || git checkout "$BRANCH_NAME"
    else
      echo "Creating milestone branch: $BRANCH_NAME"
      echo "All phases in this milestone will be committed to this branch."
      git switch -c "$BRANCH_NAME" 2>/dev/null || git checkout -b "$BRANCH_NAME"
    fi
    ```

    **If `BRANCHING_STRATEGY` = `"phase"` or `"none"`:**

    No action. Phase branches are created at execute-phase time, and "none" stays on current branch.
    ```

    **complete-milestone.md:**

    Add a new step **7.5** (after step 7 "Commit and tag" and before step 8 "Offer next steps") that provides branch merge guidance when a branching strategy is active:

    ```markdown
    7.5. **Branch merge guidance**

       Read branching strategy:
       ```bash
       BRANCHING_STRATEGY=$(cat .planning/config.json 2>/dev/null | grep -o '"branching_strategy"[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[^"]*"$' | tr -d '"' || echo "none")
       CURRENT_BRANCH=$(git branch --show-current)
       ```

       **If on a `gsd/` branch (regardless of strategy):**

       Display merge guidance:
       ```
       ───────────────────────────────────────────────────────────────
       ## Branch Merge

       Currently on: {CURRENT_BRANCH}

       To merge this milestone's work back to main:

         git switch main
         git merge {CURRENT_BRANCH}
         git branch -d {CURRENT_BRANCH}

       Or to squash all commits into one (loses per-task history):

         git switch main
         git merge --squash {CURRENT_BRANCH}
         git commit -m "feat: milestone {version} — {name}"
         git branch -D {CURRENT_BRANCH}

       Note: Squash merge loses per-task commit history. Standard merge
       preserves the full audit trail. Choose based on your preference.
       ───────────────────────────────────────────────────────────────
       ```

       **If `BRANCHING_STRATEGY` = `"phase"`:**

       Also list any remaining phase branches that haven't been cleaned up:
       ```bash
       echo "Phase branches for this milestone:"
       git branch --list "gsd/phase-*"
       ```

       **If not on a `gsd/` branch:** No merge guidance needed.
    ```

    Also add to complete-milestone.md's success_criteria section:
    ```
    - Branch merge guidance shown (if on gsd/ branch)
    ```
  </action>
  <verify>
    1. Read new-milestone.md — verify Phase 6.7 exists between Phase 6.5 and Phase 7
    2. Verify milestone branch name format is gsd/{version}-{slug}
    3. Verify idempotent branch creation pattern used
    4. Verify milestone branch only created when strategy is "milestone" (not "phase" or "none")
    5. Read complete-milestone.md — verify step 7.5 exists between step 7 and step 8
    6. Verify merge guidance shows both standard merge and squash merge commands
    7. Verify squash merge documented as manual workaround with tradeoff warning
    8. Verify phase branch listing shown when strategy is "phase"
  </verify>
  <done>
    new-milestone.md creates gsd/{version}-{slug} branch when strategy is "milestone". complete-milestone.md shows merge guidance (standard and squash) when on a gsd/ branch. Squash merge is documented as a manual git command with clear tradeoff warning (not an automated feature). Phase branch cleanup listed for "phase" strategy users.
  </done>
</task>

</tasks>

<verification>
1. execute-phase.md has step 1.5 with branch creation before wave execution
2. new-milestone.md has Phase 6.7 with milestone branch creation
3. complete-milestone.md has step 7.5 with merge guidance
4. All three commands read branching_strategy with "none" default
5. Branch creation is idempotent in both execute-phase and new-milestone
6. Slug generation follows established tr/sed pattern
7. Squash merge documented as manual option with tradeoff warning
</verification>

<success_criteria>
- Phase execution with branching_strategy=phase creates gsd/phase-{N}-{slug} branch
- Phase execution with branching_strategy=milestone warns if not on gsd/ branch
- New milestone with branching_strategy=milestone creates gsd/{version}-{slug} branch
- Complete milestone shows merge guidance when on gsd/ branch
- Squash merge is documented as manual command (not automated)
- All branch creation is idempotent (safe for resume)
- Default behavior (branching_strategy=none) is unchanged from current
</success_criteria>

<output>
After completion, create `.planning/phases/03-git-branching/03-02-SUMMARY.md`
</output>
